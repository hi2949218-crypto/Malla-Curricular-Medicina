<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Planner Medicina UBA</title>
  <style>
    :root{
      --blue-700: #1e40af;
      --blue-600: #2563eb;
      --bg: #f1f5f9;
      --panel-bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
    }

    html,body{margin:0;padding:0;font-family:Arial, Helvetica, sans-serif;background:var(--bg);color:var(--text);}

    /* ---------- TABS ---------- */
    .tabs {
      display:flex;
      gap:6px;
      background:var(--blue-700);
      padding:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .tabs [role="tab"]{
      flex:1 1 auto;
      padding:12px 16px;
      border:0;
      background:transparent;
      color:#fff;
      cursor:pointer;
      font-size:15px;
      text-align:center;
      border-radius:8px;
      transition: background .12s, transform .06s;
    }

    .tabs [role="tab"]:hover{ background:rgba(255,255,255,0.06); transform:translateY(-1px); }
    .tabs [role="tab"]:focus{ outline:3px solid rgba(255,255,255,0.18); outline-offset:2px; }

    /* estado activo */
    .tabs [role="tab"][aria-selected="true"]{
      background:var(--blue-600);
      box-shadow: 0 2px 0 rgba(0,0,0,0.08) inset;
      font-weight:600;
    }

    /* ---------- CONTENIDO ---------- */
    .tab {
      display:none;
      padding:20px;
      background:var(--panel-bg);
      margin:16px;
      border-radius:10px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.06);
    }

    .tab.activa { display:block; }

    /* Tipografía y layout */
    h2{ margin-top:0; color:#0b1220; }
    p{ line-height:1.5; color:#334155; }

    /* ===== Glosario / Asistente ===== */
    .glosario-form {
      display:flex;
      gap:8px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .glosario-form input[type="search"]{
      flex:1 1 320px;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      font-size:15px;
      background:#fff;
    }
    .glosario-form button {
      padding:10px 14px;
      border-radius:8px;
      border:0;
      background:var(--blue-600);
      color:#fff;
      cursor:pointer;
      font-weight:600;
    }
    .sugerencias {
      margin-bottom:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .sugerencia {
      background:#eef2ff;
      color:#1e3a8a;
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      border:1px solid rgba(30,58,138,0.06);
    }
    .resultado {
      background:#fff;
      border:1px solid #e2e8f0;
      padding:14px;
      border-radius:8px;
    }
    .nota {
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
    }

    /* imagen resumen */
    .resultado img { max-width:180px; float:right; margin-left:12px; border-radius:6px; }

    /* ===== MALLA (tabla de materias por año) ===== */
    .malla-controls {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
      align-items:center;
    }
    .malla-controls input, .malla-controls select {
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #cbd5e1;
      font-size:14px;
      background:#fff;
    }
    .malla-controls button {
      padding:9px 12px;
      border-radius:6px;
      border:0;
      background:var(--blue-600);
      color:#fff;
      cursor:pointer;
      font-weight:600;
    }
    .malla-years {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .year-box {
      flex:1 1 240px;
      background:#f8fafc;
      border:1px solid #e6eefc;
      padding:12px;
      border-radius:8px;
    }
    .materia {
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .materia .name { flex:1; font-weight:600; color:#0f172a; }
    .materia input[type="number"]{ width:84px; padding:6px; border-radius:6px; border:1px solid #e2e8f0; }
    .materia .avg { min-width:56px; text-align:center; font-weight:700; color:#0b1220; }
    .materia button.small {
      padding:6px 8px; border-radius:6px; border:0; cursor:pointer; background:#ef4444; color:#fff; font-size:13px;
    }

    /* ===== CALENDARIO simple ===== */
    .cal-form { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .cal-form input, .cal-form textarea { padding:8px; border-radius:6px; border:1px solid #cbd5e1; background:#fff; }
    .cal-list { margin-top:10px; display:flex; flex-direction:column; gap:8px; }

    /* Responsive */
    @media (max-width:680px){
      .malla-years { flex-direction:column; }
      .tabs [role="tab"]{ font-size:14px; padding:10px; }
      .tab{ margin:12px; padding:14px; }
      .resultado img { float:none; display:block; margin:8px auto 12px; max-width:100%; }
    }
  </style>
</head>
<body>

  <!-- ---------- PESTAÑAS ---------- -->
  <nav class="tabs" role="tablist" aria-label="Navegación principal">
    <button id="tab-malla" role="tab" aria-controls="malla" aria-selected="false" tabindex="0">Malla</button>
    <button id="tab-glosario" role="tab" aria-controls="glosario" aria-selected="false" tabindex="-1">Asistente</button>
    <button id="tab-calendario" role="tab" aria-controls="calendario" aria-selected="false" tabindex="-1">Calendario</button>
  </nav>

  <main>
    <!-- ---------- MALLA ---------- -->
    <section id="malla" class="tab" role="tabpanel" aria-labelledby="tab-malla" tabindex="0">
      <h2>Malla</h2>

      <div class="malla-controls" aria-label="Controles malla">
        <input id="materiaNombre" placeholder="Nombre de la materia (ej. Anatomía)" aria-label="Nombre de la materia">
        <select id="materiaYear" aria-label="Año de la materia">
          <option value="1">Año 1</option>
          <option value="2">Año 2</option>
          <option value="3">Año 3</option>
          <option value="4">Año 4</option>
          <option value="5">Año 5</option>
          <option value="6">Año 6</option>
        </select>
        <button id="btnAgregarMateria">Agregar materia</button>

        <button id="btnExport" style="margin-left:auto;background:#10b981;">Exportar JSON</button>
        <button id="btnImport" style="background:#f59e0b;">Importar JSON</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none;">
      </div>

      <div class="malla-years" id="mallaYears" aria-live="polite">
        <!-- Contenido dinámico: cajas por año -->
      </div>

      <p class="nota">Haz clic en una caja de año para ver / editar las materias. Las notas se guardan en tu navegador (localStorage).</p>
    </section>

    <!-- ---------- GLOSARIO / ASISTENTE (WIKIPEDIA) ---------- -->
    <section id="glosario" class="tab" role="tabpanel" aria-labelledby="tab-glosario" tabindex="0">
      <h2>Asistente (búsqueda en Wikipedia)</h2>

      <div class="glosario-form" role="search" aria-label="Buscar concepto">
        <input id="buscarTermino" type="search" placeholder="Escribe un término o pregunta (ej. 'anatomía del corazón')" aria-label="Término a buscar">
        <button id="btnBuscar" type="button">Buscar</button>
      </div>

      <div id="sugerencias" class="sugerencias" aria-live="polite"></div>

      <div id="resultado" class="resultado" aria-live="polite">
        <p class="nota">Escribe un término y pulsa "Buscar". El asistente mostrará el resumen de la página de Wikipedia (si existe).</p>
      </div>

      <p class="nota">Nota: este asistente usa Wikipedia en español (API pública). Si quieres respuestas más conversacionales (GPT), te explico las opciones.</p>
    </section>

    <!-- ---------- CALENDARIO ---------- -->
    <section id="calendario" class="tab" role="tabpanel" aria-labelledby="tab-calendario" tabindex="0">
      <h2>Calendario</h2>

      <div class="cal-form">
        <input id="evFecha" type="date" aria-label="Fecha del evento">
        <input id="evTitulo" placeholder="Titulo del evento (ej. Parcial Anatomía)" aria-label="Titulo del evento">
        <button id="btnAddEvent">Agregar evento</button>
        <button id="btnClearEvents" style="background:#ef4444;">Borrar todos</button>
      </div>

      <div id="eventList" class="cal-list"></div>

      <p class="nota">Eventos guardados en tu navegador (localStorage).</p>
    </section>
  </main>

  <script>
  (function(){
    /* ===== PESTAÑAS (igual que antes) ===== */
    const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
    const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

    function mostrarTab(id, updateHash = true){
      panels.forEach(p => p.classList.remove('activa'));
      tabs.forEach(t => {
        t.setAttribute('aria-selected','false');
        t.setAttribute('tabindex','-1');
      });

      const panel = document.getElementById(id);
      const tab = tabs.find(t => t.getAttribute('aria-controls') === id);
      if(panel && tab){
        panel.classList.add('activa');
        tab.setAttribute('aria-selected','true');
        tab.setAttribute('tabindex','0');
        tab.focus({preventScroll:true});
        if(updateHash){
          history.replaceState(null, '', '#' + id);
        }
      }
    }

    tabs.forEach(t => {
      t.addEventListener('click', () => mostrarTab(t.getAttribute('aria-controls')));
      t.addEventListener('keydown', (e) => {
        const idx = tabs.indexOf(t);
        let newIdx = null;
        if(e.key === 'ArrowRight') newIdx = (idx + 1) % tabs.length;
        else if(e.key === 'ArrowLeft') newIdx = (idx - 1 + tabs.length) % tabs.length;
        else if(e.key === 'Home') newIdx = 0;
        else if(e.key === 'End') newIdx = tabs.length - 1;

        if(newIdx !== null){
          e.preventDefault();
          tabs[newIdx].focus();
        }
      });
      t.addEventListener('keyup', (e) => {
        if(e.key === 'Enter' || e.key === ' '){
          mostrarTab(t.getAttribute('aria-controls'));
        }
      });
    });

    function initFromHash(){
      const hash = location.hash.replace('#','');
      const valid = panels.some(p => p.id === hash);
      if(valid) mostrarTab(hash, false);
      else mostrarTab('malla', false);
    }
    window.addEventListener('hashchange', () => {
      const id = location.hash.replace('#','');
      if(id) mostrarTab(id, false);
    });

    /* ===== ASISTENTE WIKIPEDIA (igual que antes) ===== */
    const input = document.getElementById('buscarTermino');
    const btn = document.getElementById('btnBuscar');
    const sugerenciasEl = document.getElementById('sugerencias');
    const resultadoEl = document.getElementById('resultado');

    async function buscarSugerencias(q){
      sugerenciasEl.innerHTML = '';
      if(!q || q.trim().length < 2) return;
      try{
        const url = 'https://es.wikipedia.org/w/api.php?action=opensearch&format=json&limit=6&origin=*&search=' + encodeURIComponent(q);
        const res = await fetch(url);
        if(!res.ok) throw new Error('Error en búsqueda');
        const data = await res.json();
        const titulos = data[1] || [];
        titulos.forEach(t => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'sugerencia';
          b.textContent = t;
          b.addEventListener('click', () => getResumen(t));
          sugerenciasEl.appendChild(b);
        });
      }catch(err){
        console.warn('Sugerencias error:', err);
      }
    }

    async function getResumen(title){
      resultadoEl.innerHTML = '<p class="nota">Cargando...</p>';
      try{
        const url = 'https://es.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(title);
        const res = await fetch(url);
        if(res.status === 404){
          resultadoEl.innerHTML = '<p class="nota">No se encontró el término en Wikipedia.</p>';
          return;
        }
        if(!res.ok) throw new Error('Error al obtener resumen');
        const data = await res.json();
        const html = [];
        html.push('<h3>' + escapeHtml(data.title || title) + '</h3>');
        if(data.thumbnail && data.thumbnail.source){
          html.push('<img src="' + escapeHtml(data.thumbnail.source) + '" alt="' + escapeHtml(data.title || '') + '">');
        }
        if(data.extract_html){
          html.push('<div>' + data.extract_html + '</div>');
        } else if(data.extract){
          html.push('<p>' + escapeHtml(data.extract) + '</p>');
        } else {
          html.push('<p class="nota">No hay resumen disponible.</p>');
        }
        if(data.content_urls && data.content_urls.desktop && data.content_urls.desktop.page){
          html.push('<p class="nota"><a href="' + escapeHtml(data.content_urls.desktop.page) + '" target="_blank" rel="noopener">Leer en Wikipedia</a></p>');
        }
        resultadoEl.innerHTML = html.join('');
      }catch(err){
        resultadoEl.innerHTML = '<p class="nota">Error al buscar. Intenta de nuevo.</p>';
        console.error('getResumen error:', err);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"]/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[m];
      });
    }

    btn.addEventListener('click', () => {
      const q = input.value.trim();
      if(!q) return;
      buscarSugerencias(q).then(() => {
        const first = sugerenciasEl.querySelector('.sugerencia');
        if(first){
          getResumen(first.textContent);
        } else {
          getResumen(q);
        }
      });
    });
    let timer = null;
    input.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(() => buscarSugerencias(input.value.trim()), 350);
    });
    input.addEventListener('keyup', (e) => {
      if(e.key === 'Enter') btn.click();
    });

    /* ===== MALLA: estado en localStorage + UI ===== */
    const STORAGE_KEY = 'mallaData_v1';
    const defaultYears = [1,2,3,4,5,6];

    // estructura: { materias: [ {id, name, year, p1, p2} ] }
    function loadMalla(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { materias: [] };
        return JSON.parse(raw);
      }catch(e){
        console.warn('Error parse malla', e);
        return { materias: [] };
      }
    }
    function saveMalla(data){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    const mallaYearsEl = document.getElementById('mallaYears');
    const materiaNombre = document.getElementById('materiaNombre');
    const materiaYear = document.getElementById('materiaYear');
    const btnAgregarMateria = document.getElementById('btnAgregarMateria');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileImport = document.getElementById('fileImport');

    let malla = loadMalla();

    function renderMalla(){
      mallaYearsEl.innerHTML = '';
      defaultYears.forEach(year => {
        const box = document.createElement('div');
        box.className = 'year-box';
        box.setAttribute('data-year', year);
        box.innerHTML = '<h3>Año ' + year + '</h3><div class="materias-list"></div>';
        const list = box.querySelector('.materias-list');

        const materiasDelYear = malla.materias.filter(m => Number(m.year) === year);
        if(materiasDelYear.length === 0){
          const empty = document.createElement('p');
          empty.className = 'nota';
          empty.textContent = 'No hay materias en este año.';
          list.appendChild(empty);
        } else {
          materiasDelYear.forEach(m => {
            const row = document.createElement('div');
            row.className = 'materia';
            row.innerHTML = `
              <div class="name" title="${escapeHtml(m.name)}">${escapeHtml(m.name)}</div>
              <input type="number" min="0" max="10" step="0.1" value="${m.p1 ?? ''}" data-id="${m.id}" data-field="p1" aria-label="Parcial 1 ${escapeHtml(m.name)}">
              <input type="number" min="0" max="10" step="0.1" value="${m.p2 ?? ''}" data-id="${m.id}" data-field="p2" aria-label="Parcial 2 ${escapeHtml(m.name)}">
              <div class="avg">${calcAvg(m.p1, m.p2)}</div>
              <button class="small" data-action="delete" data-id="${m.id}" title="Eliminar materia">Eliminar</button>
            `;
            list.appendChild(row);
          });
        }
        mallaYearsEl.appendChild(box);
      });

      // Attach listeners to inputs and delete buttons
      mallaYearsEl.querySelectorAll('input[type="number"]').forEach(inp => {
        inp.addEventListener('change', (e) => {
          const id = inp.dataset.id;
          const field = inp.dataset.field;
          const val = inp.value === '' ? null : Number(inp.value);
          const mat = malla.materias.find(x => x.id === id);
          if(mat){
            mat[field] = val;
            saveMalla(malla);
            renderMalla(); // refresh to update avg
          }
        });
      });
      mallaYearsEl.querySelectorAll('button[data-action="delete"]').forEach(b => {
        b.addEventListener('click', () => {
          const id = b.dataset.id;
          malla.materias = malla.materias.filter(x => x.id !== id);
          saveMalla(malla);
          renderMalla();
        });
      });
    }

    function calcAvg(p1, p2){
      const a = (p1 === null || p1 === undefined || p1 === '') ? null : Number(p1);
      const b = (p2 === null || p2 === undefined || p2 === '') ? null : Number(p2);
      if(a === null && b === null) return '--';
      if(a === null) return (b).toFixed(1);
      if(b === null) return (a).toFixed(1);
      return ((a + b) / 2).toFixed(1);
    }

    function uid(){
      return 'm' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    }

    btnAgregarMateria.addEventListener('click', () => {
      const name = materiaNombre.value.trim();
      const year = materiaYear.value;
      if(!name){
        alert('Escribe el nombre de la materia.');
        return;
      }
      const nueva = { id: uid(), name, year: Number(year), p1: null, p2: null };
      malla.materias.push(nueva);
      saveMalla(malla);
      materiaNombre.value = '';
      materiaYear.value = '1';
      renderMalla();
    });

    btnExport.addEventListener('click', () => {
      const dataStr = JSON.stringify(malla, null, 2);
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'malla-export.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => fileImport.click());
    fileImport.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try{
          const data = JSON.parse(ev.target.result);
          if(!data || !Array.isArray(data.materias)) throw new Error('Formato inválido');
          malla = data;
          saveMalla(malla);
          renderMalla();
          alert('Importación completa.');
        }catch(err){
          alert('Error importando JSON: ' + err.message);
        }
      };
      reader.readAsText(f);
    });

    // Inicializar malla (cargar ejemplo si vacío)
    if(!malla || !Array.isArray(malla.materias)) malla = { materias: [] };
    renderMalla();

    /* ===== CALENDARIO simple ===== */
    const EVENTS_KEY = 'planner_events_v1';
    const evFecha = document.getElementById('evFecha');
    const evTitulo = document.getElementById('evTitulo');
    const btnAddEvent = document.getElementById('btnAddEvent');
    const eventList = document.getElementById('eventList');
    const btnClearEvents = document.getElementById('btnClearEvents');

    function loadEvents(){
      try{
        const raw = localStorage.getItem(EVENTS_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch(e){ return []; }
    }
    function saveEvents(arr){ localStorage.setItem(EVENTS_KEY, JSON.stringify(arr)); }

    let events = loadEvents();

    function renderEvents(){
      eventList.innerHTML = '';
      if(events.length === 0){
        eventList.innerHTML = '<p class="nota">No hay eventos.</p>';
        return;
      }
      // ordenar por fecha asc
      events.sort((a,b) => a.date.localeCompare(b.date));
      events.forEach(ev => {
        const el = document.createElement('div');
        el.style.background = '#fff';
        el.style.border = '1px solid #e6eefc';
        el.style.padding = '10px';
        el.style.borderRadius = '8px';
        el.innerHTML = `<strong>${escapeHtml(ev.date)}</strong> — ${escapeHtml(ev.title)} <button style="float:right;background:#ef4444;color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer;" data-id="${ev.id}">Eliminar</button>`;
        eventList.appendChild(el);
      });
      eventList.querySelectorAll('button[data-id]').forEach(b => {
        b.addEventListener('click', () => {
          const id = b.dataset.id;
          events = events.filter(x => x.id !== id);
          saveEvents(events);
          renderEvents();
        });
      });
    }

    btnAddEvent.addEventListener('click', () => {
      const date = evFecha.value;
      const title = evTitulo.value.trim();
      if(!date || !title){ alert('Completa fecha y título'); return; }
      events.push({ id: uid(), date, title });
      saveEvents(events);
      evFecha.value = '';
      evTitulo.value = '';
      renderEvents();
    });

    btnClearEvents.addEventListener('click', () => {
      if(!confirm('Borrar todos los eventos?')) return;
      events = [];
      saveEvents(events);
      renderEvents();
    });

    renderEvents();

    /* Inicializar pestañas desde hash y listo */
    initFromHash();

    // small helper log to console
    console.log('Planner inicializado — malla guardada en localStorage key:', STORAGE_KEY);
  })();
  </script>

</body>
</html>
